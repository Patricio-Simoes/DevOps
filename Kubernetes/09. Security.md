---
Date: 2025-01-18
Technology: Kubernetes
tags:
  - Container_Orchestration
  - DevOps
---
**Table of Contents**

- [09. Security](#09-security)
  - [Authentication](#authentication)
    - [Users](#users)
      - [Static password \& token files](#static-password--token-files)
      - [Certificates](#certificates)
        - [Generating the CA certificate](#generating-the-ca-certificate)
        - [User Certificates](#user-certificates)
      - [KubeConfig](#kubeconfig)
        - [KubeConfig commands](#kubeconfig-commands)
          - [Checking the current KubeConfig](#checking-the-current-kubeconfig)
          - [Switching KubeConfig context](#switching-kubeconfig-context)
          - [Checking the current KubeConfig context](#checking-the-current-kubeconfig-context)
  - [Authorization](#authorization)
    - [Node Authorization](#node-authorization)
    - [Attribute Based Access Controls (ABAC)](#attribute-based-access-controls-abac)
    - [Role Based Access Controls (RBAC)](#role-based-access-controls-rbac)
      - [Role \& RoleBinding Objects](#role--rolebinding-objects)
  - [Role \& RoleBinding Commands](#role--rolebinding-commands)
    - [Checking Role \& RoleBinding information](#checking-role--rolebinding-information)
    - [Webhook](#webhook)

# 09. Security

## Authentication

Authentication is the process of verifying the identity of a user, service account, or process trying to access the Kubernetes API.

A Kubernetes cluster has two categories of users:

- **Service accounts** (managed by Kubernetes);
- **Normal users**.

### Users

User access is managed by the [API server](01.%20Overview.md#API%20Server).

<div align="center">
    <img src="../Assets/Images/Diagrams/Kubernetes/User Authentication.png" alt="User Authentication">
</div>

It is possible to configure the following authentication methods:

- Static password file;
- Static token file;
- Certificates;
- Third party authentication protocol.

#### Static password & token files

For these authentication methods, a list of user details is required to serve as the source of information.

This file has three required columns, (`password/token`, `username`, `userId`).

A fourth opcional column can also be added with `groupId`.

E.g:

```csv
password123,user1,u001,group1
password123,user2,u002,group2
EFKNW9UFGWEIUFBIOWERUGNF9,user2,u002,group2
49T8YU3OIBWE9FHVCBURIEWUB,user2,u002,group2
```

This file must be passed to the [API server](01.%20Overview.md#API%20Server) service using:

```bash
ExecStart=/usr/local/bin/kube-apiserver \
  # Case for password auth:
  --basic-auth-file=user-details.csv
  # Case for token auth:
  --token-auth-file=user-details.csv
  (...)
```

After the file is created, authentication occurs using the following `curl`syntax:

```bash
curl -v -k https://master-node-ip:6443/api/v1/pods -u "user1:password123"
```

> [!WARNING] Security of these methods
> This is not a recommended way of setting up user authentication due to the fact that the credentials are stored in plain text in the user details file.

#### Certificates

Kubernetes uses certificates extensively to secure communication between its components like the [API server](01.%20Overview.md#API%20Server), [kubelets](01.%20Overview.md#Kubelet), [`etcd`](01.%20Overview.md#`etcd`%20Keystore), and clients.

The trust anchor for verifying certificates is the certificate authority (CA). There are two types of Certificate Authorities:

- Cluster CA : Used to sign all internal certificates;
- External CA : For public-facing services or user certificates. (E.g. Let's encrypt).

##### Generating the CA certificate

Certificates can be generated with tools like `openssl`. The CA certificate can be generated using the following commands:

```bash
# Create private key.
openssl genrsa -out ca.key 2048
# Generate signing request.
openssl req -new -key ca.key -subj "/CN=KUBERNETES-CA" -out ca.csr
# Sign certificate
openssl x509 -req -in ca.csr -signkey ca.key -out ca.crt
```

##### User Certificates

User certificates are used to authenticate users (e.g., administrators, developers) when they interact with the Kubernetes API via `kubectl` or other clients.

To generate such certificates,

1. Create a private key and CSR for the user:

```bash
# Create private key.
openssl genrsa -out user.key 2048
# Generate signing request.
openssl req -new -key user.key -subj "/CN=<USER>" -out user.csr
# Sign certificate with the prevously created CA key pair. (Making this a valid certificate within the cluster).
openssl x509 -req -in user.csr -CA ca.crt -CAkey ca.key -out ca.crt
```

>[!TIP] Normal vs Admin users
>A user must be part of the `SYSTEM:MASTERS` group in order to be considered an Admin user. This is done by adding the following group parameter while generating the CSR (Certificate Signing Request):
>```bash
>openssl req -new -key user.key -subj "/CN=<USER>/OU:system:masters" -out user.csr
>```

**Note:** This process is used for generating client certificates for all other components that access the [API server](01.%20Overview.md#API%20Server).

After the certificate is created, authentication occurs using the following `curl`syntax:

```bash
curl -v -k https://master-node-ip:6443/api/v1/pods -key user.key --cert user.crt --cacert ca.crt
```

**Note:** These parameters are often omitted because they are specified in the [KubeConfig](#KubeConfig). 

#### KubeConfig

A KubeConfig file is a configuration file used by CLI tools like `kubectl` to authenticate and communicate with a cluster. This file is composed by:

- **Cluster details**: API server addresses and certificates;
- **User credentials**: Authentication information (certificates, tokens, or basic auth);
- **Contexts**: Combinations of clusters and users, allowing to switch between different clusters or namespaces easily.

This file is used by CLI tools for determining which cluster to query and how to authenticate.

##### KubeConfig commands

###### Checking the current KubeConfig

To print the current KubeConfig, using `kubectl`, run:

```bash
kubectl config view
```

###### Switching KubeConfig context

To switch the context used in kubeconfig, using `kubectl`, run:

```bash
kubectl config use-context <context>
```

###### Checking the current KubeConfig context

To print the current kubeconfig context, using `kubectl`, run:

```bash
kubectl config current-context
```

## Authorization

Authorization determines what actions an authenticated user or service account is allowed to perform on Kubernetes resources.

Kubernetes supports the following authorization mechanisms:

- Node Authorization;
- Attribute Based Access Controls (ABAC);
- Role Based Access Controls (RBAC);
- Webhook.

### Node Authorization

Requests made from [node](01.%20Overview.md#Nodes%20(Minions)) [kubelets](01.%20Overview.md#Kubelet) are validated by the node authorizer.

If the [kubelet](01.%20Overview.md#Kubelet) is part of the `SYSTEM:NODES` group, then, requests are authorized by the node authorizer.

> [!INFO] `SYSTEN:NODES`
> The `SYSTEM:NODES` group is associated to the [Kubelet](01.%20Overview.md#Kubelet) when generating the certificate for the node.

The Node Authorizer only allows [kubelets](01.%20Overview.md#Kubelet) to perform actions related to their own [node](01.%20Overview.md#Nodes%20(Minions)), such as:
    
- Reading and writing pods bound to the [node](01.%20Overview.md#Nodes%20(Minions)).
- Reading and writing secrets/configmaps referenced by [pods](02.%20Pods.md#02.%20Pods) on the [node](01.%20Overview.md#Nodes%20(Minions)).
- Updating [node](01.%20Overview.md#Nodes%20(Minions)) status.

<div align="center">
    <img src="../Assets/Images/Diagrams/Kubernetes/Node Authorizer.png" alt="Node Authorizer">
</div>

### Attribute Based Access Controls (ABAC)

Attribute Based Access Controls, (ABAC), is where a user or set of users are associated with a group of permissions. For instance, a dev user can be able to:

- View [pods](02.%20Pods.md#02.%20Pods);
- Create [pods](02.%20Pods.md#02.%20Pods);
- Delete [pods](02.%20Pods.md#02.%20Pods).

This is established by creating a JSON formatted policy file that is passed to the [API server](01.%20Overview.md#API%20Server). E.g:

```json
"kind": "Policy",
"spec": {
  "user": "dev-user",
  "namespace": "*",
  "resource": "pods",
  "apiGroup": "*"
}
```

This file must be updated manually every time a change is required, as well as restarting the [API server](01.%20Overview.md#API%20Server).

### Role Based Access Controls (RBAC)

Role Based Access Controls, (RBAC), is similar to [Attribute Based Access Controls (ABAC)](#Attribute%20Based%20Access%20Controls%20(ABAC)), but, instead of assigning permissions to a user, permissions are assigned to a role.

Users can inherit role permissions if they are associated with the role.

<div align="center">
    <img src="../Assets/Images/Diagrams/Kubernetes/Role Based Access Controls.png" alt="Role Based Access Controls">
</div>

Roles are created using Role objects.

#### Role & RoleBinding Objects

RBAC authorization uses the `rbac.authorization.k8s.io` API group to drive authorization decisions.

Role objects are created from a YAML file using the following structure:

```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: developer
rules:
- apiGroups: [""] # This is blank only for the core API Group.
  resources: ["pods"]
  verbs: ["list", "get", "create", "update", "delete"]
- apiGroups: [""] # This is blank only for the core API Group.
  resources: ["ConfigMap"]
  verbs: ["create"]
```

Then, using `kubectl`, run:

```bash
kubectl apply -f <file-name>
```

After the role is created, users are associated to it using a RoleBinding object:

```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: devuser-developer-binding
subjects:
- kind: User
  name: dev-user
  apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: Role
  name: developer
  apiGroup: rbac.authorization.k8s.io
```

Then, using `kubectl`, run:

```bash
kubectl apply -f <file-name>
```
 
> [!TIP] How can users check their permissions?
> If a user wants to check what permissions he has access to, the user can use the following `kubectl`command:
> ```bash
> kubectl auth can-i <command>
> ```
> E.g:
> ```bash
> kubectl auth can-i create deployments
> # Or:
> kubectl auth can-i delete nodes --namespace sandbox
> ```
> An Administrador can impersonate a user by running:
> ```bash
> kubectl auth can-i create deployments --as dev-user
> ``` 

## Role & RoleBinding Commands

### Checking Role & RoleBinding information

To list available Roles & RoleBindings, using `kubectl` run:

```bash
kubectl get roles -n <namespace>
kubectl get rolebindings -n <namespace>
```

To describe a Role or RoleBinding, using `kubectl` run:

```bash
kubectl describe role/<role_name> -n <namespace>
kubectl describe rolebinding/<rolebinding_name> -n <namespace>
```

### Webhook

Webhook is used for external authorization mechanisms.

When using webhook, authorization can be performed using a third-party took, such as [Open Policy Agent](https://www.openpolicyagent.org).